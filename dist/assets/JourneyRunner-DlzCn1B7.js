import{c as H,a as r,j as e,B as Re,L as te,o as G,p as Ue,n as $e,f as J,P as xe,k as le,T as Ae,A as ze,S as he,i as Ve,q as Ge,C as We,e as Xe,s as P,t as Qe}from"./index-BTAm5qeQ.js";import{C as He,V as we,P as qe,I as ke,H as Ce,R as re,U as Ye,F as Oe,u as Ke,B as Se,d as es,e as Ee,a as ss,f as ts,c as as,E as ls,b as rs,D as ns,L as is}from"./useAIEnabled-DjOQSQKw.js";const os=H("Award",[["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}],["path",{d:"M15.477 12.89 17 22l-5-3-5 3 1.523-9.11",key:"em7aur"}]]);const cs=H("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);const ve=H("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);const ds=H("EyeOff",[["path",{d:"M9.88 9.88a3 3 0 1 0 4.24 4.24",key:"1jxqfv"}],["path",{d:"M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68",key:"9wicm4"}],["path",{d:"M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61",key:"1jreej"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);const Me=H("File",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]]);const je=H("Home",[["path",{d:"m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"y5dka4"}],["polyline",{points:"9 22 9 12 15 12 15 22",key:"e2us08"}]]);const ms=H("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);const us=H("Maximize",[["path",{d:"M8 3H5a2 2 0 0 0-2 2v3",key:"1dcmit"}],["path",{d:"M21 8V5a2 2 0 0 0-2-2h-3",key:"1e4gt3"}],["path",{d:"M3 16v3a2 2 0 0 0 2 2h3",key:"wsl5sc"}],["path",{d:"M16 21h3a2 2 0 0 0 2-2v-3",key:"18trek"}]]);const Fe=H("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);const _e=H("SkipForward",[["polygon",{points:"5 4 15 12 5 20 5 4",key:"16p6eg"}],["line",{x1:"19",x2:"19",y1:"5",y2:"19",key:"futhcm"}]]);const xs=H("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]);const hs=H("Trophy",[["path",{d:"M6 9H4.5a2.5 2.5 0 0 1 0-5H6",key:"17hqa7"}],["path",{d:"M18 9h1.5a2.5 2.5 0 0 0 0-5H18",key:"lmptdp"}],["path",{d:"M4 22h16",key:"57wxv0"}],["path",{d:"M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22",key:"1nw9bq"}],["path",{d:"M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22",key:"1np0yb"}],["path",{d:"M18 2H6v7a6 6 0 0 0 12 0V2Z",key:"u46fv3"}]]);const ps=H("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);const fs=H("Volume2",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}],["path",{d:"M15.54 8.46a5 5 0 0 1 0 7.07",key:"ltjumu"}],["path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14",key:"1kegas"}]]);const bs=H("VolumeX",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]);const Be=H("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);const gs=H("ZoomIn",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);const js=H("ZoomOut",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);function Te(s,v){const l=v[s.fact],t=s.value;switch(s.op){case"eq":return l===t;case"neq":return l!==t;case"gt":return typeof l=="number"&&typeof t=="number"&&l>t;case"gte":return typeof l=="number"&&typeof t=="number"&&l>=t;case"lt":return typeof l=="number"&&typeof t=="number"&&l<t;case"lte":return typeof l=="number"&&typeof t=="number"&&l<=t;case"contains":return Array.isArray(l)||typeof l=="string"&&typeof t=="string"?l.includes(t):!1;case"in":return Array.isArray(t)?t.includes(l):!1;default:return!1}}function ye(s,v){return s.all?s.all.every(l=>"fact"in l?Te(l,v):ye(l,v)):s.any?s.any.some(l=>"fact"in l?Te(l,v):ye(l,v)):!0}function ws(s,v){return s.condition?ye(s.condition,v):!0}function vs(s,v,l){const t=v.filter(o=>o.from===s).sort((o,i)=>(i.priority??0)-(o.priority??0));for(const o of t)if(ws(o,l))return o.to;return t.find(o=>!o.condition)?.to??null}function Ie(s,v){const l={};if(s.score!==void 0&&s.score!==null&&(l["quiz.scorePercent"]=s.score),s.weak_topics&&s.weak_topics.length>0&&(l["quiz.weakTopics"]=s.weak_topics),v?.questions){const t=v.questions.length;l["quiz.totalCount"]=t,s.score!==void 0&&s.score!==null&&(l["quiz.correctCount"]=Math.round(s.score/100*t))}return s.attempts_count!==void 0&&(l["block.attemptsCount"]=s.attempts_count),s.time_spent_seconds!==void 0&&(l["block.timeSpentSeconds"]=s.time_spent_seconds),s.status&&(l["block.status"]=s.status),s.output_json&&Object.entries(s.output_json).forEach(([t,n])=>{l[`output.${t}`]=n}),l}function ys({term:s,contextSnippet:v,trackId:l,moduleId:t}){const[n,o]=r.useState(!1),[i,E]=r.useState(null),[N,b]=r.useState(!1),[k,j]=r.useState(null),[u,p]=r.useState(null),a=r.useRef(null),x=r.useRef(null);r.useEffect(()=>{if(n&&a.current){const d=a.current.getBoundingClientRect(),g=window.innerHeight,T=150,f=g-d.bottom<T&&d.top>T;p({top:f?d.top-T-8:d.bottom+8,left:Math.max(16,Math.min(d.left,window.innerWidth-280)),arrowPosition:f?"bottom":"top"})}},[n]),r.useEffect(()=>{const d=g=>{x.current&&!x.current.contains(g.target)&&a.current&&!a.current.contains(g.target)&&o(!1)};return n&&(document.addEventListener("mousedown",d),document.addEventListener("touchstart",d)),()=>{document.removeEventListener("mousedown",d),document.removeEventListener("touchstart",d)}},[n]);const h=async()=>{if(!i){b(!0),j(null);try{const d=await fetch("https://sowihdefjgpagncacfhy.supabase.co/functions/v1/glossary-explain",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNvd2loZGVmamdwYWduY2FjZmh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMjQ3MjksImV4cCI6MjA4MzcwMDcyOX0.XDE5-zoORpJVimoK6OfkZVi_M1q9Y6FGCZUeUhHOgGE"},body:JSON.stringify({term:s,contextSnippet:v,trackId:l,moduleId:t})});if(!d.ok)throw new Error("Failed to fetch explanation");const g=await d.json();E(g.explanation)}catch(d){j("تعذر تحميل الشرح"),console.error("Glossary fetch error:",d)}finally{b(!1)}}},C=()=>{o(!n),!n&&!i&&h()};return e.jsxs(e.Fragment,{children:[e.jsx("span",{ref:a,className:"english-term",onClick:C,onKeyDown:d=>d.key==="Enter"&&C(),role:"button",tabIndex:0,"aria-expanded":n,"aria-haspopup":"dialog",children:s}),n&&u&&e.jsxs("div",{ref:x,className:"glossary-popup fixed",style:{top:u.top,left:u.left,width:"260px"},role:"dialog","aria-label":`شرح ${s}`,children:[e.jsx("div",{className:"glossary-popup-arrow",style:{[u.arrowPosition==="top"?"top":"bottom"]:"-6px",left:"20px",transform:u.arrowPosition==="top"?"rotate(45deg)":"rotate(225deg)"}}),e.jsxs("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-slate-700",children:[e.jsx(Re,{className:"w-4 h-4 text-blue-400"}),e.jsx("span",{className:"font-english text-blue-300 font-medium",children:s})]}),e.jsxs("div",{className:"arabic-content text-sm",children:[N&&e.jsxs("div",{className:"flex items-center gap-2 text-slate-400",children:[e.jsx(te,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"جاري التحميل..."})]}),k&&e.jsx("div",{className:"text-red-400 text-sm",children:k}),i&&!N&&e.jsx("p",{className:"text-slate-200 leading-relaxed",children:i})]})]})]})}const Ns=/\b([A-Za-z][A-Za-z0-9]*(?:\s+[A-Za-z][A-Za-z0-9]*){0,3})\b/g,ks=new Set(["a","an","the","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","may","might","must","shall","can","need","dare","ought","used","to","of","in","for","on","with","at","by","from","up","about","into","over","after","and","or","but","if","then","else","when","where","why","how","all","each","every","both","few","more","most","other","some","such","no","nor","not","only","own","same","so","than","too","very","just","also","now","here","there","this","that","these","those","i","you","he","she","it","we","they","me","him","her","us","them","my","your","his","its","our","their","what","which","who","whom"]),Cs=[/^[A-Z]{2,}$/,/^[A-Z][a-z]+[A-Z]/,/\d/,/^(API|SDK|UI|UX|CSS|HTML|JS|JSON|XML|SQL|HTTP|REST|GraphQL|Git|npm|AI|ML|GPT|LLM|RAG|NLP|CNN|RNN|LSTM|GAN|VAE|RL|DL|IoT|AWS|GCP|Azure|Docker|K8s|Kubernetes|React|Vue|Angular|Node|Python|Java|Go|Rust|Swift|Kotlin|TypeScript|JavaScript|PHP|Ruby|Scala|Clojure|Haskell|Elixir|Erlang|C|CPP|CSharp|FSharp|VB|Perl|Lua|Dart|Flutter|Android|iOS|macOS|Windows|Linux|Unix|Ubuntu|Debian|Fedora|CentOS|RedHat|SUSE|Arch|Alpine|Mint|Elementary|Pop|Manjaro|Kali|Parrot|BlackArch|Tails|Qubes|Whonix)$/i];function Ss(s){const v=s.toLowerCase();if(ks.has(v)||s.length<2)return!1;for(const l of Cs)if(l.test(s))return!0;return!!(s.length>=4&&/^[A-Z]/.test(s))}function Es(s,v,l){const n=Math.max(0,v-100),o=Math.min(s.length,v+l+100);let i=s.slice(n,o);return n>0&&(i="..."+i),o<s.length&&(i=i+"..."),i}function Ms({children:s,trackId:v,moduleId:l,className:t=""}){const n=r.useMemo(()=>{const o=s,i=[];let E=0;const N=[...o.matchAll(Ns)];for(const b of N){const k=b[1],j=b.index;if(!Ss(k))continue;j>E&&i.push(o.slice(E,j));const u=Es(o,j,k.length);i.push(e.jsx(ys,{term:k,contextSnippet:u,trackId:v,moduleId:l},`${k}-${j}`)),E=j+k.length}return E<o.length&&i.push(o.slice(E)),i.length>0?i:o},[s,v,l]);return e.jsx("span",{className:`arabic-content ${t}`,children:n})}function _s({content:s,onComplete:v,isCompleted:l,trackId:t,moduleId:n}){const{t:o}=G(),{isRTL:i,direction:E,primaryLanguage:N}=Ue(),[b,k]=r.useState(0),[j,u]=r.useState(!1);r.useEffect(()=>{const C=document.getElementById("read-content-scroll");if(!C)return;const d=()=>{C.scrollHeight<=C.clientHeight&&(u(!0),k(100))},g=()=>{const T=C.scrollHeight-C.clientHeight;if(T<=0){u(!0),k(100);return}const R=C.scrollTop/T*100;k(Math.min(100,R)),R>=90&&u(!0)};return d(),C.addEventListener("scroll",g),window.addEventListener("resize",d),()=>{C.removeEventListener("scroll",g),window.removeEventListener("resize",d)}},[s.markdown]);const p=C=>{const d=C.split(`
`),g=[];let T=!1,R="";return d.forEach((f,m)=>{if(f.startsWith("```")){T?(g.push(e.jsx("pre",{className:"bg-slate-900 text-slate-100 p-4 rounded-lg overflow-x-auto my-4 text-sm font-mono",children:e.jsx("code",{children:R})},`code-${m}`)),R="",T=!1):(T=!0,f.slice(3));return}if(T){R+=(R?`
`:"")+f;return}if(f.startsWith("### "))g.push(e.jsx("h3",{className:"text-lg font-semibold text-slate-800 mt-6 mb-3",children:f.slice(4)},m));else if(f.startsWith("## "))g.push(e.jsx("h2",{className:"text-xl font-bold text-slate-900 mt-8 mb-4",children:f.slice(3)},m));else if(f.startsWith("# "))g.push(e.jsx("h1",{className:"text-2xl font-bold text-slate-900 mt-8 mb-4",children:f.slice(2)},m));else if(f.startsWith("- ")||f.startsWith("* "))g.push(e.jsx("li",{className:"text-slate-700 ml-4 mb-2 list-disc",children:x(f.slice(2))},m));else if(f.match(/^\d+\. /)){const _=f.replace(/^\d+\. /,"");g.push(e.jsx("li",{className:"text-slate-700 ml-4 mb-2 list-decimal",children:x(_)},m))}else f.startsWith("> ")?g.push(e.jsx("blockquote",{className:"border-l-4 border-primary-500 pl-4 py-2 my-4 bg-primary-50 text-slate-700 italic",children:x(f.slice(2))},m)):f.trim()===""?g.push(e.jsx("div",{className:"h-4"},m)):g.push(e.jsx("p",{className:"text-slate-700 leading-relaxed mb-4",children:x(f)},m))}),g},a=(C,d)=>i&&typeof C=="string"?e.jsx(Ms,{trackId:t,moduleId:n,className:"inline",children:C},d):C,x=C=>{const d=[];let g=C,T=0;for(;g.length>0;){const R=g.match(/\*\*(.+?)\*\*/),f=g.match(/\*(.+?)\*/),m=g.match(/`(.+?)`/),_=g.match(/\[(.+?)\]\((.+?)\)/),$=[R?{type:"bold",match:R,index:R.index}:null,f?{type:"italic",match:f,index:f.index}:null,m?{type:"code",match:m,index:m.index}:null,_?{type:"link",match:_,index:_.index}:null].filter(Boolean).sort((c,y)=>c.index-y.index);if($.length===0){d.push(i?a(g,T++):g);break}const S=$[0];if(S.index>0){const c=g.slice(0,S.index);d.push(i?a(c,T++):c)}switch(S.type){case"bold":d.push(e.jsx("strong",{className:"font-semibold text-slate-900",children:i?a(S.match[1],T++):S.match[1]},T++)),g=g.slice(S.index+S.match[0].length);break;case"italic":d.push(e.jsx("em",{className:"italic",children:i?a(S.match[1],T++):S.match[1]},T++)),g=g.slice(S.index+S.match[0].length);break;case"code":d.push(e.jsx("code",{className:"bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono text-slate-800",children:S.match[1]},T++)),g=g.slice(S.index+S.match[0].length);break;case"link":d.push(e.jsx("a",{href:S.match[2],target:"_blank",rel:"noopener noreferrer",className:"text-primary-600 hover:text-primary-800 underline",children:S.match[1]},T++)),g=g.slice(S.index+S.match[0].length);break}}return d},h={continue:o("blocks.read.continue"),complete:o("blocks.markComplete"),scroll:o("blocks.read.continue"),minRead:o("track.min")};return e.jsxs("div",{className:"flex flex-col h-full bg-white",dir:E,children:[e.jsxs("div",{className:"border-b border-slate-200 px-6 py-4",children:[e.jsxs("div",{className:`flex items-center gap-3 mb-2 ${i?"flex-row-reverse":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center",children:e.jsx(Re,{className:"w-5 h-5 text-primary-600"})}),e.jsxs("div",{className:i?"text-right":"",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900",children:s.title}),s.estimatedReadTime&&e.jsxs("div",{className:`flex items-center gap-1 text-sm text-slate-500 ${i?"flex-row-reverse":""}`,children:[e.jsx($e,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.estimatedReadTime," ",h.minRead]})]})]})]}),e.jsx("div",{className:"h-1 bg-slate-100 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full bg-primary-500 transition-all duration-300 ${i?"ml-auto":""}`,style:{width:`${b}%`,marginLeft:i?"auto":void 0,marginRight:i?"0":void 0}})})]}),e.jsx("div",{id:"read-content-scroll",className:`flex-1 overflow-y-auto px-6 py-6 ${i?"arabic-content":""}`,children:e.jsx("div",{className:"max-w-3xl mx-auto",children:p(s.markdown)})}),e.jsx("div",{className:"border-t border-slate-200 px-6 py-4 bg-slate-50",children:e.jsxs("button",{onClick:v,disabled:!j&&!l,className:`
            w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium transition-all
            ${i?"flex-row-reverse":""}
            ${j||l?"bg-primary-600 text-white hover:bg-primary-700 shadow-sm":"bg-slate-200 text-slate-400 cursor-not-allowed"}
          `,children:[l?h.continue:j?h.complete:h.scroll,i?e.jsx(He,{className:"w-5 h-5"}):e.jsx(J,{className:"w-5 h-5"})]})})]})}function Ts({content:s,onComplete:v,isCompleted:l}){const{t}=G(),[n,o]=r.useState(!1),[i,E]=r.useState(!1),[N,b]=r.useState(0),[k,j]=r.useState(!1),[u,p]=r.useState(!1),[a,x]=r.useState(!1),[h,C]=r.useState(!1),[d,g]=r.useState(!1),[T,R]=r.useState(!1),f=r.useRef(null),m=r.useRef(null),_=r.useRef(null),$=r.useRef(0),S=s.url.includes("youtube.com")||s.url.includes("youtu.be"),c=s.url.includes("vimeo.com"),y=M=>{const O=M.split(".").pop()?.toLowerCase().split("?")[0];return{mp4:"video/mp4",webm:"video/webm",ogg:"video/ogg",ogv:"video/ogg",mov:"video/quicktime",m4v:"video/mp4",avi:"video/x-msvideo",wmv:"video/x-ms-wmv"}[O||""]||"video/mp4"},I=M=>{const O=M.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/);return O?O[1]:null},V=M=>{const O=M.match(/vimeo\.com\/(\d+)/);return O?O[1]:null},q=r.useCallback(()=>{j(!0)},[]);r.useEffect(()=>{if(!S&&!c&&!h&&!a)return _.current=window.setTimeout(()=>{R(!0),g(!0)},1e4),()=>{_.current&&clearTimeout(_.current)}},[S,c,h,a]),r.useEffect(()=>{const M=f.current;if(!M)return;const O=()=>{console.log("Video metadata loaded, duration:",M.duration),C(!0),R(!1),_.current&&clearTimeout(_.current)},X=()=>{console.log("Video can play"),C(!0),R(!1),_.current&&clearTimeout(_.current)},ce=()=>{if(!M.duration||!isFinite(M.duration))return;const ee=M.currentTime/M.duration*100;b(isFinite(ee)?ee:0),$.current=M.currentTime,ee>=80&&j(!0),M.currentTime>=30&&!d&&g(!0)},oe=()=>{console.log("Video playing"),o(!0)},ae=()=>{console.log("Video paused"),o(!1)},F=()=>{console.log("Video ended"),o(!1),j(!0)},de=ee=>{const pe=ee.target;console.error("Video loading error:",pe.error?.message||"Unknown error"),x(!0),g(!0)},me=()=>{console.log("Video stalled"),setTimeout(()=>{h||g(!0)},5e3)},ue=()=>{console.log("Video waiting/buffering")};return M.addEventListener("loadedmetadata",O),M.addEventListener("canplay",X),M.addEventListener("timeupdate",ce),M.addEventListener("play",oe),M.addEventListener("pause",ae),M.addEventListener("ended",F),M.addEventListener("error",de),M.addEventListener("stalled",me),M.addEventListener("waiting",ue),M.readyState>=2&&(console.log("Video already loaded from cache"),C(!0),R(!1)),M.load(),()=>{M.removeEventListener("loadedmetadata",O),M.removeEventListener("canplay",X),M.removeEventListener("timeupdate",ce),M.removeEventListener("play",oe),M.removeEventListener("pause",ae),M.removeEventListener("ended",F),M.removeEventListener("error",de),M.removeEventListener("stalled",me),M.removeEventListener("waiting",ue)}},[s.url,d,h]);const D=()=>{f.current&&(n?f.current.pause():f.current.play())},W=()=>{f.current&&(f.current.muted=!i,E(!i))},K=()=>{f.current&&(document.fullscreenElement?document.exitFullscreen():f.current.requestFullscreen())},ne=M=>{if(f.current&&m.current){const O=m.current.getBoundingClientRect(),X=(M.clientX-O.left)/O.width*100;f.current.currentTime=X/100*f.current.duration}},ie=M=>{const O=Math.floor(M/60),X=Math.floor(M%60);return`${O}:${X.toString().padStart(2,"0")}`};return e.jsxs("div",{className:"flex flex-col h-full bg-slate-900 overflow-hidden",children:[e.jsxs("div",{className:"flex-1 flex flex-col min-h-0",children:[e.jsxs("div",{className:"relative flex-1 min-h-0 bg-black flex items-center justify-center overflow-hidden",children:[S?e.jsx("iframe",{className:"w-full h-full",src:`https://www.youtube.com/embed/${I(s.url)}?rel=0&modestbranding=1`,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0,onLoad:()=>j(!0)}):c?e.jsx("iframe",{className:"w-full h-full",src:`https://player.vimeo.com/video/${V(s.url)}`,allow:"autoplay; fullscreen; picture-in-picture",allowFullScreen:!0,onLoad:()=>j(!0)}):e.jsxs(e.Fragment,{children:[e.jsxs("video",{ref:f,className:"w-full h-full object-contain",playsInline:!0,preload:"metadata",children:[e.jsx("source",{src:s.url,type:y(s.url)}),t("blocks.video.noSupport")]}),!h&&!a&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-slate-900/80",children:e.jsxs("div",{className:"text-center px-6",children:[e.jsx(te,{className:"w-12 h-12 text-primary-400 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-slate-300 text-sm",children:t(T?"blocks.video.slowLoading":"blocks.video.loading")}),T&&e.jsxs("button",{onClick:q,className:"mt-4 px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition-colors flex items-center gap-2 mx-auto",children:[e.jsx(_e,{className:"w-4 h-4"}),t("blocks.video.skipVideo")]})]})}),a&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-slate-900/90",children:e.jsxs("div",{className:"text-center px-6",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-error/20 flex items-center justify-center",children:e.jsx(we,{className:"w-8 h-8 text-error"})}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:t("blocks.video.unavailable")}),e.jsx("p",{className:"text-slate-300 text-sm mb-4",children:t("blocks.video.unavailableDesc")}),e.jsx("button",{onClick:q,className:"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:t("blocks.video.continueAnyway")})]})})]}),!S&&!c&&!n&&h&&!a&&e.jsx("button",{onClick:D,className:"absolute inset-0 flex items-center justify-center bg-black/30 hover:bg-black/40 transition-colors",children:e.jsx("div",{className:"w-20 h-20 rounded-full bg-white/90 flex items-center justify-center shadow-xl",children:e.jsx(xe,{className:"w-10 h-10 text-slate-900 ml-1"})})})]}),!S&&!c&&e.jsxs("div",{className:"bg-slate-800 px-4 py-3",children:[e.jsx("div",{ref:m,className:"h-1.5 bg-slate-600 rounded-full cursor-pointer mb-3",onClick:ne,children:e.jsx("div",{className:"h-full bg-primary-500 rounded-full transition-all",style:{width:`${N}%`}})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:D,className:"w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center transition-colors",children:n?e.jsx(qe,{className:"w-5 h-5 text-white"}):e.jsx(xe,{className:"w-5 h-5 text-white ml-0.5"})}),e.jsx("button",{onClick:W,className:"w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center transition-colors",children:i?e.jsx(bs,{className:"w-5 h-5 text-white"}):e.jsx(fs,{className:"w-5 h-5 text-white"})}),e.jsxs("span",{className:"text-sm text-slate-300",children:[f.current?ie(f.current.currentTime):"0:00"," / "," ",s.duration?ie(s.duration):f.current?ie(f.current.duration||0):"0:00"]})]}),e.jsx("button",{onClick:K,className:"w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center transition-colors",children:e.jsx(us,{className:"w-5 h-5 text-white"})})]})]})]}),e.jsxs("div",{className:"bg-slate-800 border-t border-slate-700",children:[e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-primary-500/20 flex items-center justify-center",children:e.jsx(we,{className:"w-5 h-5 text-primary-400"})}),e.jsx("h2",{className:"text-xl font-bold text-white",children:s.title})]}),s.transcript&&e.jsx("button",{onClick:()=>p(!u),className:"text-sm text-primary-400 hover:text-primary-300 mt-2",children:t(u?"blocks.video.hideTranscript":"blocks.video.showTranscript")}),u&&s.transcript&&e.jsx("div",{className:"mt-4 p-4 bg-slate-900 rounded-lg max-h-48 overflow-y-auto",children:e.jsx("p",{className:"text-sm text-slate-300 leading-relaxed whitespace-pre-wrap",children:s.transcript})})]}),e.jsxs("div",{className:"px-6 py-4 border-t border-slate-700",children:[d&&!k&&!l&&e.jsxs("button",{onClick:q,className:"w-full flex items-center justify-center gap-2 px-4 py-2 mb-3 rounded-lg font-medium bg-slate-700 text-slate-300 hover:bg-slate-600 transition-colors text-sm",children:[e.jsx(_e,{className:"w-4 h-4"}),t("blocks.video.skipVideo")]}),e.jsxs("button",{onClick:v,disabled:!k&&!l,className:`
              w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium transition-all
              ${k||l?"bg-primary-600 text-white hover:bg-primary-700":"bg-slate-700 text-slate-400 cursor-not-allowed"}
            `,children:[t(l?"blocks.continue":k?"blocks.markComplete":h?"blocks.video.watchToComplete":"blocks.video.loading"),e.jsx(J,{className:"w-5 h-5"})]})]})]})]})}function Is({content:s,onComplete:v,isCompleted:l}){const{t}=G(),[n,o]=r.useState(!0),[i,E]=r.useState(!1),[N,b]=r.useState(!1),k=()=>{o(!1)},j=()=>{o(!1),b(!0)};return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsx("div",{className:"border-b border-slate-200 px-6 py-4",children:e.jsx("h2",{className:"text-2xl font-bold text-slate-900",children:s.title})}),e.jsx("div",{className:"flex-1 overflow-auto p-6",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:s.url?e.jsxs("div",{className:"relative",children:[n&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-slate-100 rounded-xl",children:e.jsx(te,{className:"w-8 h-8 text-slate-400 animate-spin"})}),N?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 bg-slate-100 rounded-xl",children:[e.jsx(ke,{className:"w-12 h-12 text-slate-400 mb-4"}),e.jsx("p",{className:"text-slate-500",children:t("blocks.image.failed")})]}):e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:s.url,alt:s.alt||s.title,className:`w-full rounded-xl shadow-lg transition-transform cursor-pointer ${i?"scale-150 cursor-zoom-out":"cursor-zoom-in"}`,onLoad:k,onError:j,onClick:()=>E(!i)}),e.jsx("button",{onClick:()=>E(!i),className:"absolute top-4 right-4 p-2 bg-black/50 text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity",children:i?e.jsx(js,{className:"w-5 h-5"}):e.jsx(gs,{className:"w-5 h-5"})})]}),s.caption&&e.jsx("p",{className:"mt-4 text-center text-slate-600 italic",children:s.caption})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 bg-slate-100 rounded-xl",children:[e.jsx(ke,{className:"w-12 h-12 text-slate-400 mb-4"}),e.jsx("p",{className:"text-slate-500",children:t("blocks.image.noImage")})]})})}),e.jsx("div",{className:"border-t border-slate-200 px-6 py-4",children:e.jsx("div",{className:"max-w-4xl mx-auto flex justify-end",children:e.jsxs("button",{onClick:v,disabled:l,className:`flex items-center gap-2 px-6 py-3 rounded-xl font-medium transition-all ${l?"bg-emerald-100 text-emerald-700 cursor-default":"bg-primary-600 text-white hover:bg-primary-700"}`,children:[t(l?"blocks.complete":"blocks.continue"),e.jsx(J,{className:"w-5 h-5"})]})})})]})}function Ls({content:s,onComplete:v,previousAttempt:l}){const{t}=G(),[n,o]=r.useState(0),[i,E]=r.useState({}),[N,b]=r.useState(!1),[k,j]=r.useState(!1),[u,p]=r.useState([]),[a,x]=r.useState(null);r.useEffect(()=>{let c=[...s.questions];s.shuffleQuestions&&(c=c.sort(()=>Math.random()-.5)),p(c)},[s.questions,s.shuffleQuestions]);const h=u[n],C=s.passingScore??50,d=h&&i[h.id]!==void 0,g=h&&i[h.id]===h.correctIndex,T=()=>h?s.shuffleChoices?h.choices.map((y,I)=>({choice:y,originalIndex:I})).sort(()=>Math.random()-.5):h.choices.map((c,y)=>({choice:c,originalIndex:y})):[],[R]=r.useState([]);s.shuffleChoices||h?.choices.map((c,y)=>({choice:c,originalIndex:y})),r.useEffect(()=>{if(h&&s.shuffleChoices){const c=h.choices.map((y,I)=>({choice:y,originalIndex:I}));R.length=0,R.push(...c.sort(()=>Math.random()-.5))}},[n,h,s.shuffleChoices]);const f=c=>{d||(E({...i,[h.id]:c}),j(!0))},m=()=>{j(!1),n<u.length-1?o(n+1):_()},_=()=>{let c=0;const y=new Set;u.forEach(q=>{i[q.id]===q.correctIndex?c++:q.tags.forEach(D=>y.add(D))});const I=Math.round(c/u.length*100),V={score:I,correctCount:c,totalCount:u.length,answers:i,weakTopics:Array.from(y),passed:I>=C};x(V),b(!0)},$=()=>{E({}),o(0),b(!1),j(!1),x(null),s.shuffleQuestions&&p([...s.questions].sort(()=>Math.random()-.5))},S=()=>{a&&v(a)};return N&&a?e.jsx("div",{className:"flex flex-col h-full bg-white",children:e.jsx("div",{className:"flex-1 flex items-center justify-center p-6",children:e.jsxs("div",{className:"max-w-md w-full text-center",children:[e.jsx("div",{className:`w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center ${a.passed?"bg-success/20":"bg-warning/20"}`,children:a.passed?e.jsx(os,{className:"w-12 h-12 text-emerald-600"}):e.jsx(Ce,{className:"w-12 h-12 text-warning"})}),e.jsx("h2",{className:"text-2xl font-bold text-slate-900 mb-2",children:a.passed?t("blocks.quiz.result.passed"):t("blocks.quiz.result.failed")}),e.jsx("p",{className:"text-slate-600 mb-6",children:a.passed?t("blocks.quiz.result.passedMessage"):t("blocks.quiz.result.failedMessage")}),e.jsxs("div",{className:"bg-slate-50 rounded-xl p-6 mb-6",children:[e.jsxs("div",{className:"text-5xl font-bold text-slate-900 mb-2",children:[a.score,"%"]}),e.jsxs("div",{className:"text-slate-500",children:[a.correctCount," ",t("blocks.quiz.of")," ",a.totalCount," ",t("blocks.quiz.result.correct")]}),e.jsx("div",{className:"mt-4 h-3 bg-slate-200 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all ${a.passed?"bg-success":"bg-warning"}`,style:{width:`${a.score}%`}})}),e.jsxs("div",{className:"mt-2 text-sm text-slate-500",children:[t("blocks.quiz.result.yourScore"),": ",C,"%"]})]}),a.weakTopics.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-700 mb-2",children:t("blocks.quiz.topicsToReview")}),e.jsx("div",{className:"flex flex-wrap gap-2 justify-center",children:a.weakTopics.map(c=>e.jsx("span",{className:"px-3 py-1 bg-warning/20 text-warning rounded-full text-sm",children:c},c))})]}),e.jsxs("div",{className:"flex gap-3",children:[s.allowRetry!==!1&&!a.passed&&e.jsxs("button",{onClick:$,className:"flex-1 flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors",children:[e.jsx(re,{className:"w-5 h-5"}),t("blocks.quiz.retry")]}),e.jsxs("button",{onClick:S,className:`flex-1 flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium transition-colors ${a.passed?"bg-primary-600 text-white hover:bg-primary-700":"bg-warning text-white hover:bg-warning/90"}`,children:[a.passed?t("blocks.continue"):t("blocks.aiHelp.askForHelp"),e.jsx(J,{className:"w-5 h-5"})]})]})]})})}):h?e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsxs("div",{className:"border-b border-slate-200 px-6 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center",children:e.jsx(Ce,{className:"w-5 h-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-slate-900",children:s.title}),s.description&&e.jsx("p",{className:"text-sm text-slate-500",children:s.description})]})]}),e.jsxs("div",{className:"text-sm font-medium text-slate-500",children:[t("blocks.quiz.question")," ",n+1," ",t("blocks.quiz.of")," ",u.length]})]}),e.jsx("div",{className:"flex gap-1.5",children:u.map((c,y)=>e.jsx("div",{className:`h-1.5 flex-1 rounded-full transition-colors ${y<n?i[u[y].id]===u[y].correctIndex?"bg-emerald-500":"bg-red-500":y===n?"bg-blue-500":"bg-slate-200"}`},y))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-8",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsx("h3",{className:"text-xl font-semibold text-slate-900 mb-6",children:h.prompt}),e.jsx("div",{className:"space-y-3",children:(s.shuffleChoices?T():h.choices.map((c,y)=>({choice:c,originalIndex:y}))).map(({choice:c,originalIndex:y})=>{const I=i[h.id]===y,V=y===h.correctIndex,q=d;let D="bg-white hover:bg-slate-50 border-slate-200",W="text-slate-700",K=null;return q?V?(D="bg-emerald-50 border-emerald-500",W="text-emerald-900",K=e.jsx(le,{className:"w-6 h-6 text-emerald-600"})):I&&!V&&(D="bg-error/10 border-error",W="text-red-900",K=e.jsx(Be,{className:"w-6 h-6 text-red-600"})):I&&(D="bg-blue-50 border-blue-500",W="text-blue-900"),e.jsxs("button",{onClick:()=>f(y),disabled:d,className:`w-full flex items-center gap-4 p-4 rounded-xl border-2 transition-all ${D} ${d?"cursor-default":"cursor-pointer"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full border-2 flex items-center justify-center font-medium ${q?V?"border-emerald-500 bg-emerald-500 text-white":I?"border-red-500 bg-red-500 text-white":"border-slate-300 text-slate-500":I?"border-blue-500 bg-blue-500 text-white":"border-slate-300 text-slate-500"}`,children:String.fromCharCode(65+y)}),e.jsx("span",{className:`flex-1 text-left font-medium ${W}`,children:c}),K]},y)})}),k&&h.explanation&&e.jsxs("div",{className:`mt-6 p-4 rounded-lg ${g?"bg-emerald-50 border border-emerald-200":"bg-amber-50 border border-amber-200"}`,children:[e.jsx("h4",{className:`font-medium mb-1 ${g?"text-emerald-800":"text-amber-800"}`,children:t(g?"blocks.quiz.result.correct":"blocks.quiz.result.incorrect")}),e.jsx("p",{className:`text-sm ${g?"text-emerald-700":"text-amber-700"}`,children:h.explanation})]})]})}),d&&e.jsx("div",{className:"border-t border-slate-200 px-6 py-4 bg-slate-50",children:e.jsxs("button",{onClick:m,className:"w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors",children:[n<u.length-1?t("blocks.quiz.next"):t("blocks.submit"),e.jsx(J,{className:"w-5 h-5"})]})})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-primary-600 border-t-transparent rounded-full"})})}function Rs({content:s,onComplete:v,previousOutput:l}){const{t}=G(),[n,o]=r.useState(new Set(l?.completedSteps||[])),[i,E]=r.useState(!1),[N,b]=r.useState({}),[k,j]=r.useState(null),[u,p]=r.useState({}),[a,x]=r.useState(l?.validationHistory||{}),h=s.steps.every(m=>n.has(m.id)),C=m=>{const _=new Set(n);_.has(m)?_.delete(m):_.add(m),o(_)},d=()=>{v({completedSteps:Array.from(n),validationHistory:a})},g=(m,_)=>{b($=>({...$,[m]:_})),p($=>({...$,[m]:null}))},T=async m=>{const _=N[m.id]?.trim();if(_){j(m.id);try{const $=await fetch("https://sowihdefjgpagncacfhy.supabase.co/functions/v1/mission-validate",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNvd2loZGVmamdwYWduY2FjZmh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMjQ3MjksImV4cCI6MjA4MzcwMDcyOX0.XDE5-zoORpJVimoK6OfkZVi_M1q9Y6FGCZUeUhHOgGE"},body:JSON.stringify({question:m.instruction,userAnswer:_,expectedCriteria:m.expectedCriteria||"The answer should demonstrate understanding of the concept."})});if(!$.ok)throw new Error("Validation failed");const S=await $.json();p(y=>({...y,[m.id]:S}));const c={answer:_,correct:S.correct,feedback:S.feedback,score:S.score,timestamp:new Date().toISOString()};x(y=>({...y,[m.id]:[...y[m.id]||[],c]})),S.correct&&o(y=>new Set([...y,m.id]))}catch($){console.error("AI validation error:",$),p(S=>({...S,[m.id]:{correct:!1,feedback:t("blocks.mission.unableToValidate"),score:0}}))}finally{j(null)}}},R=m=>{p(_=>({..._,[m]:null})),b(_=>({..._,[m]:""})),o(_=>{const $=new Set(_);return $.delete(m),$})},f=m=>{const _=n.has(m.id),$=k===m.id,S=u[m.id],c=a[m.id]?.length||0;switch(m.verificationMethod){case"ai_validate":return e.jsxs("div",{className:"mt-3 space-y-3",children:[!_&&e.jsxs(e.Fragment,{children:[m.inputType==="textarea"?e.jsx("textarea",{value:N[m.id]||"",onChange:y=>g(m.id,y.target.value),placeholder:t("blocks.mission.inputPlaceholder"),rows:4,disabled:$,className:"w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none disabled:bg-slate-50 disabled:text-slate-400"}):e.jsx("input",{type:"text",value:N[m.id]||"",onChange:y=>g(m.id,y.target.value),placeholder:t("blocks.mission.inputPlaceholder"),disabled:$,className:"w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-slate-50 disabled:text-slate-400"}),e.jsx("button",{onClick:()=>T(m),disabled:$||!N[m.id]?.trim(),className:"flex items-center justify-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors",children:$?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-4 h-4 animate-spin"}),t("blocks.mission.checking")]}):e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"w-4 h-4"}),t("blocks.mission.submitAnswer")]})})]}),S&&e.jsx("div",{className:`p-4 rounded-lg ${S.correct?"bg-emerald-50 border border-emerald-200":"bg-error/10 border border-error/20"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[S.correct?e.jsx(le,{className:"w-5 h-5 text-emerald-600 flex-shrink-0 mt-0.5"}):e.jsx(Be,{className:"w-5 h-5 text-error flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:`font-medium ${S.correct?"text-success":"text-error"}`,children:S.correct?t("blocks.mission.correct"):t("blocks.mission.notQuiteRight")}),e.jsxs("span",{className:`text-sm px-2 py-0.5 rounded ${S.correct?"bg-emerald-200 text-emerald-800":"bg-error/20 text-error"}`,children:[t("blocks.mission.score"),": ",S.score,"%"]})]}),e.jsx("p",{className:`text-sm ${S.correct?"text-success":"text-error"}`,children:S.feedback}),!S.correct&&e.jsxs("button",{onClick:()=>R(m.id),className:"mt-3 flex items-center gap-1 text-sm text-error hover:text-error/80 font-medium",children:[e.jsx(re,{className:"w-4 h-4"}),t("blocks.mission.tryAgain")]})]})]})}),c>0&&e.jsx("div",{className:"text-xs text-slate-500",children:c===1?t("blocks.mission.attemptsMade",{count:c}):t("blocks.mission.attemptsMadePlural",{count:c})})]});case"screenshot":return e.jsx("div",{className:"mt-2",children:e.jsxs("label",{className:"flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg cursor-pointer text-sm text-slate-600 transition-colors w-fit",children:[e.jsx(Ye,{className:"w-4 h-4"}),t(i?"blocks.mission.screenshotUploaded":"blocks.mission.uploadScreenshot"),e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:()=>{E(!0),C(m.id)}})]})});case"url_check":return e.jsx("div",{className:"mt-2",children:e.jsx("input",{type:"url",placeholder:t("blocks.mission.pasteUrl"),className:"w-full px-4 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",onChange:y=>{y.target.value&&C(m.id)}})});default:return null}};return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsx("div",{className:"border-b border-slate-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center",children:e.jsx(Ae,{className:"w-5 h-5 text-orange-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900",children:s.title}),s.description&&e.jsx("p",{className:"text-sm text-slate-500",children:s.description})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-6",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"bg-gradient-to-br from-orange-50 to-amber-50 border border-orange-200 rounded-xl p-6 mb-6",children:[e.jsx("h3",{className:"font-semibold text-orange-900 mb-2",children:t("blocks.mission.yourMission")}),e.jsx("p",{className:"text-orange-800",children:t("blocks.mission.missionDescription")})]}),s.externalUrl&&e.jsxs("a",{href:s.externalUrl,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 p-4 bg-primary-50 border border-primary-200 rounded-xl mb-6 hover:bg-primary-100 transition-colors group",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center",children:e.jsx(ve,{className:"w-5 h-5 text-primary-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-primary-900",children:t("blocks.mission.openExternal")}),e.jsx("div",{className:"text-sm text-primary-600 truncate",children:s.externalUrl})]}),e.jsx(J,{className:"w-5 h-5 text-primary-400 group-hover:translate-x-1 transition-transform"})]}),e.jsx("div",{className:"space-y-4",children:s.steps.map((m,_)=>{const $=n.has(m.id);return e.jsx("div",{className:`p-4 rounded-xl border-2 transition-all ${$?"bg-emerald-50 border-emerald-300":"bg-white border-slate-200"}`,children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("button",{onClick:()=>{(m.verificationMethod==="self_report"||!m.verificationMethod)&&C(m.id)},disabled:m.verificationMethod==="ai_validate",className:`mt-0.5 flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${$?"border-emerald-500 bg-emerald-500":m.verificationMethod==="ai_validate"?"border-slate-200 bg-slate-50 cursor-default":"border-slate-300 hover:border-slate-400"}`,children:$?e.jsx(le,{className:"w-4 h-4 text-white"}):e.jsx(cs,{className:"w-4 h-4 text-transparent"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm font-medium text-slate-500",children:[t("blocks.mission.step")," ",_+1]}),m.verificationMethod==="ai_validate"&&e.jsx("span",{className:"px-2 py-0.5 text-xs font-medium bg-primary-100 text-primary-700 rounded",children:t("blocks.mission.aiValidated")})]}),e.jsx("p",{className:`font-medium mt-1 ${$?"text-emerald-800":"text-slate-900"}`,children:m.instruction}),f(m)]})]})},m.id)})}),s.completionMessage&&h&&e.jsx("div",{className:"mt-6 p-4 bg-emerald-50 border border-emerald-200 rounded-xl",children:e.jsx("p",{className:"text-emerald-800 font-medium",children:s.completionMessage})})]})}),e.jsxs("div",{className:"border-t border-slate-200 px-6 py-4 bg-slate-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-sm text-slate-500",children:t("blocks.mission.stepsCompleted",{completed:n.size,total:s.steps.length})}),e.jsx("span",{className:`text-sm font-medium ${h?"text-emerald-600":"text-slate-400"}`,children:t(h?"blocks.mission.readyToContinue":"blocks.mission.completeAllSteps")})]}),e.jsxs("button",{onClick:d,disabled:!h,className:`w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${h?"bg-primary-600 text-white hover:bg-primary-700":"bg-slate-200 text-slate-400 cursor-not-allowed"}`,children:[t("blocks.continue"),e.jsx(J,{className:"w-5 h-5"})]})]})]})}function $s({content:s,onComplete:v,previousOutput:l}){const[t,n]=r.useState(l||{}),[o,i]=r.useState({}),[E,N]=r.useState(new Set),b=(a,x)=>{if(a.required&&(!x||typeof x=="string"&&!x.trim()))return"This field is required";if(a.validation&&typeof x=="string"){if(a.validation.minLength&&x.length<a.validation.minLength)return`Must be at least ${a.validation.minLength} characters`;if(a.validation.maxLength&&x.length>a.validation.maxLength)return`Must be no more than ${a.validation.maxLength} characters`;if(a.validation.pattern&&!new RegExp(a.validation.pattern).test(x))return"Invalid format"}return null},k=(a,x)=>{n({...t,[a]:x});const h=s.fields.find(C=>C.id===a);if(h&&E.has(a)){const C=b(h,x);i({...o,[a]:C||""})}},j=a=>{N(new Set([...E,a]));const x=s.fields.find(h=>h.id===a);if(x){const h=b(x,t[a]);i({...o,[a]:h||""})}},u=()=>{const a={};let x=!1;s.fields.forEach(h=>{const C=b(h,t[h.id]);C&&(a[h.id]=C,x=!0)}),i(a),N(new Set(s.fields.map(h=>h.id))),x||v(t)},p=a=>{const C=`w-full px-4 py-3 border rounded-lg text-slate-900 placeholder-slate-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${o[a.id]&&E.has(a.id)?"border-red-500 bg-red-50":"border-slate-200 bg-white"}`;switch(a.type){case"text":return e.jsx("input",{type:"text",value:t[a.id]||"",onChange:d=>k(a.id,d.target.value),onBlur:()=>j(a.id),placeholder:a.placeholder,className:C});case"textarea":return e.jsx("textarea",{value:t[a.id]||"",onChange:d=>k(a.id,d.target.value),onBlur:()=>j(a.id),placeholder:a.placeholder,rows:4,className:`${C} resize-none`});case"select":return e.jsxs("select",{value:t[a.id]||"",onChange:d=>k(a.id,d.target.value),onBlur:()=>j(a.id),className:C,children:[e.jsx("option",{value:"",children:a.placeholder||"Select an option..."}),a.options?.map(d=>e.jsx("option",{value:d,children:d},d))]});case"checkbox":return e.jsx("div",{className:"space-y-2",children:a.options?.map(d=>{const g=t[a.id]||[],T=g.includes(d);return e.jsxs("label",{className:"flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:T,onChange:()=>{const R=T?g.filter(f=>f!==d):[...g,d];k(a.id,R)},className:"w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"text-slate-700",children:d})]},d)})});case"radio":return e.jsx("div",{className:"space-y-2",children:a.options?.map(d=>e.jsxs("label",{className:"flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors",children:[e.jsx("input",{type:"radio",name:a.id,checked:t[a.id]===d,onChange:()=>k(a.id,d),className:"w-5 h-5 border-slate-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"text-slate-700",children:d})]},d))});default:return null}};return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsx("div",{className:"border-b border-slate-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-teal-100 flex items-center justify-center",children:e.jsx(Oe,{className:"w-5 h-5 text-teal-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900",children:s.title}),s.description&&e.jsx("p",{className:"text-sm text-slate-500",children:s.description})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-6",children:e.jsx("div",{className:"max-w-2xl mx-auto space-y-6",children:s.fields.map(a=>{const x=o[a.id],h=x&&E.has(a.id);return e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2",children:e.jsxs("span",{className:"text-sm font-medium text-slate-700",children:[a.label,a.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]})}),p(a),h&&e.jsxs("div",{className:"flex items-center gap-1.5 mt-2 text-red-600",children:[e.jsx(ze,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:x})]})]},a.id)})})}),e.jsx("div",{className:"border-t border-slate-200 px-6 py-4 bg-slate-50",children:e.jsxs("button",{onClick:u,className:"w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors",children:[s.submitLabel||"Submit",e.jsx(J,{className:"w-5 h-5"})]})})]})}function As({content:s,weakTopics:v,wrongQuestions:l,onComplete:t}){const{t:n}=G(),{enabled:o,helpModel:i,isLoading:E}=Ke(),[N,b]=r.useState([]),[k,j]=r.useState(""),[u,p]=r.useState(!1),[a,x]=r.useState(!1),[h,C]=r.useState("gpt-4o-mini"),d=r.useRef(null),g=r.useRef(null),T=s.maxTurns??5,R=2,f=N.filter(c=>c.role==="user").length;r.useEffect(()=>{f>=R&&x(!0)},[f]),r.useEffect(()=>{d.current?.scrollIntoView({behavior:"smooth"})},[N]),r.useEffect(()=>{E||m()},[E]),r.useEffect(()=>{!E&&i&&C(i)},[E,i]);const m=async()=>{p(!0);let c="";s.mode==="targeted_remediation"&&l&&l.length>0?(c=`لاحظت أنك واجهت صعوبة في بعض الأسئلة. دعني أساعدك في شرح المفاهيم:

`,l.slice(0,3).forEach((I,V)=>{c+=`**السؤال ${V+1}:** ${I.prompt}
`,c+=`إجابتك: ${I.userAnswer}
`,c+=`الإجابة الصحيحة: ${I.correctAnswer}
`,I.explanation&&(c+=`${I.explanation}
`),c+=`
`}),v&&v.length>0&&(c+=`
المواضيع الرئيسية التي يجب مراجعتها: **${v.join("، ")}**

`),c+="هل تريد مني شرح أي من هذه المفاهيم بمزيد من التفصيل؟ لا تتردد في طرح الأسئلة!"):s.mode==="guided_explanation"?c="أنا هنا لمساعدتك في فهم هذه المادة. ماذا تريد مني أن أشرح لك؟ يمكنك السؤال عن مفاهيم محددة أو طلب أمثلة.":c="مرحباً! أنا مساعدك الذكي للتعلم. أنا هنا لمساعدتك على فهم المادة بشكل أفضل. ما هي أسئلتك؟",b([{role:"assistant",content:c}]),p(!1)},_=async()=>{if(!k.trim()||u||f>=T)return;const c={role:"user",content:k.trim()};b(y=>[...y,c]),j(""),p(!0);try{const y=await fetch("https://sowihdefjgpagncacfhy.supabase.co/functions/v1/ai-help",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNvd2loZGVmamdwYWduY2FjZmh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMjQ3MjksImV4cCI6MjA4MzcwMDcyOX0.XDE5-zoORpJVimoK6OfkZVi_M1q9Y6FGCZUeUhHOgGE"},body:JSON.stringify({messages:[...N,c],mode:s.mode,weakTopics:v,wrongQuestions:l,model:h,language:"ar"})});if(!y.ok)throw new Error("Failed to get AI response");const V={role:"assistant",content:(await y.json()).response};b(q=>[...q,V])}catch{const I={role:"assistant",content:"أعتذر، ولكنني أواجه مشكلة في الاتصال الآن. يرجى المحاولة مرة أخرى أو المتابعة عندما تكون جاهزاً."};b(V=>[...V,I])}finally{p(!1)}},$=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),_())},S=()=>{t({conversationHistory:N})};return E?e.jsxs("div",{className:"flex flex-col h-full bg-slate-900 items-center justify-center",children:[e.jsx(te,{className:"w-10 h-10 text-blue-500 animate-spin"}),e.jsx("p",{className:"text-slate-400 mt-4",children:n("blocks.aiHelp.loadingAssistant")})]}):o?e.jsxs("div",{className:"flex flex-col h-full bg-slate-900",children:[e.jsx("div",{className:"border-b border-slate-700 px-6 py-4 bg-slate-800",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center",children:e.jsx(he,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:s.title}),e.jsx("p",{className:"text-sm text-slate-400",children:s.mode==="targeted_remediation"?n("blocks.aiHelp.personalizedHelp"):s.mode==="guided_explanation"?n("blocks.aiHelp.guidedLearning"):n("blocks.aiHelp.askAnything")})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-6",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[N.map((c,y)=>e.jsxs("div",{className:`flex gap-4 ${c.role==="user"?"flex-row-reverse":""}`,children:[e.jsx("div",{className:`w-10 h-10 rounded-lg flex-shrink-0 flex items-center justify-center ${c.role==="assistant"?"bg-gradient-to-br from-blue-500 to-cyan-400":"bg-slate-600"}`,children:c.role==="assistant"?e.jsx(Se,{className:"w-5 h-5 text-white"}):e.jsx(ps,{className:"w-5 h-5 text-white"})}),e.jsx("div",{className:`flex-1 max-w-[80%] rounded-2xl px-5 py-4 ${c.role==="assistant"?"bg-slate-800 text-slate-100":"bg-blue-600 text-white"}`,children:e.jsx("div",{className:"text-sm max-w-none",children:c.content.split(`
`).map((I,V)=>{if(I.startsWith("**")&&I.endsWith("**"))return e.jsx("p",{className:"font-semibold text-white mb-2",children:I.slice(2,-2)},V);if(I.includes("**")){const q=I.split(/\*\*(.+?)\*\*/g);return e.jsx("p",{className:"mb-2",children:q.map((D,W)=>W%2===1?e.jsx("strong",{className:"text-white",children:D},W):D)},V)}return I?e.jsx("p",{className:"mb-2",children:I},V):e.jsx("br",{},V)})})})]},y)),u&&e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center",children:e.jsx(Se,{className:"w-5 h-5 text-white"})}),e.jsx("div",{className:"bg-slate-800 rounded-2xl px-5 py-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"w-4 h-4 text-slate-400 animate-spin"}),e.jsx("span",{className:"text-slate-400 text-sm",children:n("blocks.aiHelp.thinking")})]})})]}),e.jsx("div",{ref:d})]})}),e.jsx("div",{className:"border-t border-slate-700 px-6 py-4 bg-slate-800",children:e.jsxs("div",{className:"max-w-3xl mx-auto",children:[f<T?e.jsx("div",{className:"flex gap-3 mb-4",children:e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("textarea",{ref:g,value:k,onChange:c=>j(c.target.value),onKeyDown:$,placeholder:n(f===0?"blocks.aiHelp.askQuestion":"blocks.aiHelp.continueConversation"),rows:1,className:"w-full px-4 py-3 pr-12 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",disabled:u}),e.jsx("button",{onClick:_,disabled:!k.trim()||u,className:"absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 disabled:cursor-not-allowed flex items-center justify-center transition-colors",children:e.jsx(Fe,{className:"w-4 h-4 text-white"})})]})}):e.jsx("div",{className:"text-center py-2 mb-4",children:e.jsx("p",{className:"text-slate-400 text-sm",children:n("blocks.aiHelp.reachedLimit")})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-slate-500",children:[f," / ",T," ",n("blocks.aiHelp.messages"),!a&&e.jsxs("span",{className:"mx-2 text-amber-400",children:["(",n("blocks.aiHelp.askMoreToontinue",{count:R-f}),")"]})]}),e.jsxs("button",{onClick:S,disabled:!a,className:`flex items-center gap-2 px-6 py-2.5 rounded-lg font-medium transition-all ${a?"bg-blue-600 text-white hover:bg-blue-700":"bg-slate-700 text-slate-400 cursor-not-allowed"}`,children:[n("blocks.aiHelp.continue"),e.jsx(J,{className:"w-5 h-5"})]})]})]})})]}):e.jsxs("div",{className:"flex flex-col h-full bg-slate-900",children:[e.jsx("div",{className:"border-b border-slate-700 px-6 py-4 bg-slate-800",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center",children:e.jsx(he,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:s.title}),e.jsx("p",{className:"text-sm text-slate-400",children:n("blocks.aiHelp.aiPowered")})]})]})}),e.jsx("div",{className:"flex-1 flex items-center justify-center p-6",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-amber-500/20 flex items-center justify-center mx-auto mb-4",children:e.jsx(Ve,{className:"w-8 h-8 text-amber-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:n("blocks.aiHelp.unavailable")}),e.jsx("p",{className:"text-slate-400 mb-6",children:n("blocks.aiHelp.unavailableMessage")}),e.jsxs("button",{onClick:()=>t({conversationHistory:[]}),className:"flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors mx-auto",children:[n("blocks.aiHelp.continue"),e.jsx(J,{className:"w-5 h-5"})]})]})})]})}function zs({content:s,facts:v,onComplete:l,allowRetry:t=!0}){const{t:n}=G(),[o,i]=r.useState(null),[E,N]=r.useState(!0);r.useEffect(()=>{b()},[]);const b=()=>{N(!0),setTimeout(()=>{const u=v["quiz.scorePercent"],p=v["block.attemptsCount"],a=v["quiz.weakTopics"];let x=!0,h=n("blocks.checkpoint.messages.greatProgress");u!==void 0&&(u>=70?(x=!0,h=n("blocks.checkpoint.messages.excellentWork",{score:u})):u>=50?(x=!0,h=n("blocks.checkpoint.messages.goodJob",{score:u})):(x=!1,h=n("blocks.checkpoint.messages.needsReview",{score:u}))),!x&&p&&p>=3&&(h=n("blocks.checkpoint.messages.multipleAttempts",{attempts:p})),!x&&a&&a.length>0&&(h+=" "+n("blocks.checkpoint.messages.focusOn",{topics:a.join("، ")})),i({passed:x,score:u,message:h}),N(!1)},1500)},k=()=>{o&&l(o.passed)},j=()=>{l(!1)};return E?e.jsx("div",{className:"flex flex-col h-full bg-white items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 rounded-full bg-blue-100 flex items-center justify-center animate-pulse",children:e.jsx(es,{className:"w-10 h-10 text-blue-600"})}),e.jsx("h2",{className:"text-xl font-bold text-slate-900 mb-2",children:n("blocks.checkpoint.evaluating")}),e.jsx("p",{className:"text-slate-500",children:n("blocks.checkpoint.checkingUnderstanding")}),e.jsxs("div",{className:"mt-8 flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-blue-600 animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-3 h-3 rounded-full bg-blue-600 animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-3 h-3 rounded-full bg-blue-600 animate-bounce",style:{animationDelay:"300ms"}})]})]})}):o?e.jsx("div",{className:"flex flex-col h-full bg-white",children:e.jsx("div",{className:"flex-1 flex items-center justify-center p-6",children:e.jsxs("div",{className:"max-w-md w-full text-center",children:[e.jsx("div",{className:`w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center ${o.passed?"bg-emerald-100":"bg-amber-100"}`,children:o.passed?e.jsx(le,{className:"w-12 h-12 text-emerald-600"}):e.jsx(Ve,{className:"w-12 h-12 text-amber-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-slate-900 mb-2",children:s.title}),s.description&&e.jsx("p",{className:"text-slate-500 mb-4",children:s.description}),e.jsxs("div",{className:`p-6 rounded-xl mb-6 ${o.passed?"bg-emerald-50 border border-emerald-200":"bg-amber-50 border border-amber-200"}`,children:[o.score!==void 0&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:`text-4xl font-bold ${o.passed?"text-emerald-700":"text-amber-700"}`,children:[o.score,"%"]}),e.jsx("div",{className:"text-sm text-slate-500 mt-1",children:n("blocks.checkpoint.yourScore")})]}),e.jsx("p",{className:`${o.passed?"text-emerald-800":"text-amber-800"}`,children:o.message})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:k,className:`w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium transition-colors ${o.passed?"bg-blue-600 text-white hover:bg-blue-700":"bg-amber-500 text-white hover:bg-amber-600"}`,children:[o.passed?n("blocks.checkpoint.continue"):n("blocks.checkpoint.getHelp"),e.jsx(Ge,{className:"w-5 h-5"})]}),!o.passed&&t&&e.jsxs("button",{onClick:j,className:"w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors",children:[e.jsx(re,{className:"w-5 h-5"}),n("blocks.checkpoint.tryAgain")]})]})]})})}):null}function Vs({content:s,onComplete:v,isCompleted:l}){const{t}=G(),[n,o]=r.useState(s.autoplay??!0),[i,E]=r.useState(!1),[N,b]=r.useState(0);r.useEffect(()=>{if(n){const p=setInterval(()=>{b(a=>a>=100?(s.loop||(o(!1),E(!0)),s.loop?0:100):a+1)},50);return()=>clearInterval(p)}},[n,s.loop]);const k=()=>{o(!n)},j=()=>{b(0),o(!0)},u=()=>{switch(s.animationType){case"lottie":return e.jsx("div",{className:"relative w-full h-full flex items-center justify-center bg-slate-100",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-48 h-48 mx-auto mb-4 bg-gradient-to-br from-blue-400 to-cyan-400 rounded-3xl flex items-center justify-center animate-pulse",children:e.jsx(Ee,{className:"w-20 h-20 text-white"})}),e.jsx("p",{className:"text-slate-500 text-sm",children:t("blocks.animation.lottieLabel",{url:s.url})})]})});case"video":return e.jsx("video",{className:"w-full h-full object-contain bg-black",src:s.url,autoPlay:s.autoplay,loop:s.loop,muted:!0,playsInline:!0,onEnded:()=>E(!0)});case"interactive":return e.jsx("div",{className:"relative w-full h-full flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"w-32 h-32 mx-auto mb-6 rounded-full border-4 border-blue-400 flex items-center justify-center",style:{background:`conic-gradient(from 0deg, #3b82f6 ${N*3.6}deg, transparent ${N*3.6}deg)`},children:e.jsx("div",{className:"w-24 h-24 rounded-full bg-slate-800 flex items-center justify-center",children:e.jsxs("span",{className:"text-2xl font-bold",children:[Math.round(N),"%"]})})}),e.jsx("p",{className:"text-slate-300",children:t("blocks.animation.interactiveLabel")})]})});default:return null}};return e.jsxs("div",{className:"flex flex-col h-full bg-slate-900",children:[e.jsx("div",{className:"border-b border-slate-700 px-6 py-4 bg-slate-800",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-cyan-500/20 flex items-center justify-center",children:e.jsx(Ee,{className:"w-5 h-5 text-cyan-400"})}),e.jsx("h2",{className:"text-xl font-bold text-white",children:s.title})]})}),e.jsxs("div",{className:"flex-1 relative overflow-hidden",children:[u(),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:!n&&N===0&&s.animationType!=="video"&&e.jsx("button",{onClick:k,className:"w-20 h-20 rounded-full bg-white/90 flex items-center justify-center shadow-xl pointer-events-auto hover:bg-white transition-colors",children:e.jsx(xe,{className:"w-10 h-10 text-slate-900 ml-1"})})})]}),e.jsxs("div",{className:"bg-slate-800 border-t border-slate-700",children:[s.animationType!=="video"&&e.jsxs("div",{className:"px-6 py-3 border-b border-slate-700",children:[e.jsx("div",{className:"h-1.5 bg-slate-700 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-cyan-500 transition-all duration-100",style:{width:`${N}%`}})}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-3",children:[e.jsx("button",{onClick:k,className:"w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center transition-colors",children:n?e.jsx(qe,{className:"w-5 h-5 text-white"}):e.jsx(xe,{className:"w-5 h-5 text-white ml-0.5"})}),e.jsx("button",{onClick:j,className:"w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center transition-colors",children:e.jsx(re,{className:"w-5 h-5 text-white"})})]})]}),e.jsx("div",{className:"px-6 py-4",children:e.jsxs("button",{onClick:v,disabled:!i&&!l&&s.animationType!=="interactive",className:`w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${i||l||s.animationType==="interactive"?"bg-blue-600 text-white hover:bg-blue-700":"bg-slate-700 text-slate-400 cursor-not-allowed"}`,children:[t(l?"blocks.continue":"blocks.markComplete"),e.jsx(J,{className:"w-5 h-5"})]})})]})]})}const Hs={javascript:"bg-yellow-500",typescript:"bg-blue-500",python:"bg-green-500",java:"bg-orange-500",csharp:"bg-purple-500",cpp:"bg-pink-500",c:"bg-gray-500",ruby:"bg-red-500",go:"bg-cyan-500",rust:"bg-orange-600",php:"bg-indigo-500",swift:"bg-orange-400",kotlin:"bg-purple-400",sql:"bg-blue-400",html:"bg-orange-500",css:"bg-blue-500",json:"bg-gray-400",bash:"bg-green-600",shell:"bg-green-600",markdown:"bg-slate-500"};function qs({content:s,onComplete:v,isCompleted:l}){const{t}=G(),[n,o]=r.useState(!1),i=s.showLineNumbers??!0,E=async()=>{try{await navigator.clipboard.writeText(s.code),o(!0),setTimeout(()=>o(!1),2e3)}catch(j){console.error("Failed to copy:",j)}},N=s.code.split(`
`),b=new Set(s.highlightLines||[]),k=Hs[s.language.toLowerCase()]||"bg-slate-500";return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsx("div",{className:"border-b border-slate-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-slate-800 flex items-center justify-center",children:e.jsx(ss,{className:"w-5 h-5 text-slate-200"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900",children:s.title}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("span",{className:`px-2 py-0.5 ${k} text-white text-xs font-medium rounded`,children:s.language}),s.description&&e.jsx("span",{className:"text-sm text-slate-500",children:s.description})]})]})]})}),e.jsx("div",{className:"flex-1 overflow-auto p-6",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"relative rounded-xl overflow-hidden bg-slate-900 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-slate-800 border-b border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-red-500"}),e.jsx("div",{className:"w-3 h-3 rounded-full bg-yellow-500"}),e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500"})]}),e.jsx("span",{className:"text-xs text-slate-400 ml-2",children:s.language})]}),e.jsx("button",{onClick:E,className:"flex items-center gap-1.5 px-2 py-1 text-xs text-slate-400 hover:text-white hover:bg-slate-700 rounded transition-colors",children:n?e.jsxs(e.Fragment,{children:[e.jsx(We,{className:"w-3.5 h-3.5 text-green-400"}),e.jsx("span",{className:"text-green-400",children:t("blocks.code.copied")})]}):e.jsxs(e.Fragment,{children:[e.jsx(ts,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:t("blocks.code.copy")})]})})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsx("pre",{className:"p-4 text-sm",children:e.jsx("code",{children:N.map((j,u)=>{const p=u+1,a=b.has(p);return e.jsxs("div",{className:`flex ${a?"bg-yellow-500/10 -mx-4 px-4":""}`,children:[i&&e.jsx("span",{className:"select-none text-slate-500 text-right pr-4 min-w-[3rem]",children:p}),e.jsx("span",{className:`flex-1 ${a?"text-yellow-200":"text-slate-100"}`,children:j||" "})]},u)})})})})]}),s.description&&e.jsx("div",{className:"mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200",children:e.jsx("p",{className:"text-slate-700 text-sm",children:s.description})})]})}),e.jsx("div",{className:"border-t border-slate-200 px-6 py-4",children:e.jsx("div",{className:"max-w-4xl mx-auto flex justify-end",children:e.jsxs("button",{onClick:v,disabled:l,className:`flex items-center gap-2 px-6 py-3 rounded-xl font-medium transition-all ${l?"bg-emerald-100 text-emerald-700 cursor-default":"bg-blue-600 text-white hover:bg-blue-700"}`,children:[t(l?"blocks.completed":"blocks.continue"),e.jsx(J,{className:"w-5 h-5"})]})})})]})}function Os({content:s,onComplete:v,previousOutput:l}){const{t}=G(),[n,o]=r.useState(l?.userSolution||""),[i,E]=r.useState(l?.solutionViewed||!1),[N,b]=r.useState(l?.hintsViewed||0),[k,j]=r.useState(!1),u=s.hints||[],p=()=>{N<u.length&&(b(N+1),j(!0))},a=()=>{E(!i)},x=()=>{v({userSolution:n,hintsViewed:N,solutionViewed:i})},h=n.trim().length>0||i;return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsx("div",{className:"border-b border-slate-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-violet-100 flex items-center justify-center",children:e.jsx(as,{className:"w-5 h-5 text-violet-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900",children:s.title}),s.description&&e.jsx("p",{className:"text-sm text-slate-500",children:s.description})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-6",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[e.jsxs("div",{className:"bg-gradient-to-br from-violet-50 to-purple-50 border border-violet-200 rounded-xl p-6",children:[e.jsxs("h3",{className:"font-semibold text-violet-900 mb-3 flex items-center gap-2",children:[e.jsx("span",{className:"w-6 h-6 rounded-full bg-violet-200 flex items-center justify-center text-xs font-bold text-violet-700",children:"?"}),t("blocks.exercise.problem")]}),e.jsx("div",{className:"text-violet-800 whitespace-pre-wrap",children:s.problem})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:t("blocks.exercise.yourSolution")}),e.jsx("textarea",{value:n,onChange:C=>o(C.target.value),rows:8,placeholder:t("blocks.exercise.placeholder"),className:"w-full px-4 py-3 border border-slate-200 rounded-xl text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent resize-none font-mono text-sm"})]}),u.length>0&&e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ms,{className:"w-5 h-5 text-amber-600"}),e.jsxs("span",{className:"font-medium text-amber-900",children:[t("blocks.exercise.hints")," (",N," / ",u.length,")"]})]}),N<u.length&&e.jsx("button",{onClick:p,className:"px-3 py-1.5 text-sm bg-amber-200 text-amber-800 rounded-lg hover:bg-amber-300 transition-colors font-medium",children:t("blocks.exercise.showHint")})]}),k&&N>0&&e.jsx("div",{className:"space-y-2",children:u.slice(0,N).map((C,d)=>e.jsxs("div",{className:"flex gap-3 p-3 bg-white/50 rounded-lg",children:[e.jsx("span",{className:"w-5 h-5 rounded-full bg-amber-200 flex-shrink-0 flex items-center justify-center text-xs font-bold text-amber-700",children:d+1}),e.jsx("p",{className:"text-amber-800 text-sm",children:C})]},d))}),N>0&&e.jsx("button",{onClick:()=>j(!k),className:"mt-2 text-sm text-amber-700 hover:text-amber-900",children:t(k?"blocks.exercise.hideHints":"blocks.exercise.showHints")})]}),e.jsxs("div",{className:"border border-slate-200 rounded-xl overflow-hidden",children:[e.jsxs("button",{onClick:a,className:"w-full flex items-center justify-between p-4 bg-slate-50 hover:bg-slate-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-5 h-5 text-emerald-600"}),e.jsx("span",{className:"font-medium text-slate-900",children:t("blocks.exercise.solution")})]}),e.jsx("div",{className:"flex items-center gap-2 text-sm text-slate-500",children:i?e.jsxs(e.Fragment,{children:[e.jsx(ds,{className:"w-4 h-4"}),t("blocks.exercise.hide")]}):e.jsxs(e.Fragment,{children:[e.jsx(ls,{className:"w-4 h-4"}),t("blocks.exercise.show")]})})]}),i&&e.jsxs("div",{className:"p-4 border-t border-slate-200",children:[e.jsx("div",{className:"bg-emerald-50 border border-emerald-200 rounded-lg p-4 mb-4",children:e.jsx("pre",{className:"whitespace-pre-wrap text-emerald-800 font-mono text-sm",children:s.solution})}),s.solutionExplanation&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"font-medium text-slate-900 mb-2",children:t("blocks.exercise.explanation")}),e.jsx("p",{className:"text-slate-700 text-sm whitespace-pre-wrap",children:s.solutionExplanation})]})]})]})]})}),e.jsx("div",{className:"border-t border-slate-200 px-6 py-4 bg-slate-50",children:e.jsxs("div",{className:"flex items-center justify-between max-w-3xl mx-auto",children:[e.jsx("div",{className:"text-sm text-slate-500",children:n.trim()?t("blocks.exercise.solutionWritten"):t(i?"blocks.exercise.solutionViewed":"blocks.exercise.writeOrView")}),e.jsxs("button",{onClick:x,disabled:!h,className:`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${h?"bg-blue-600 text-white hover:bg-blue-700":"bg-slate-200 text-slate-400 cursor-not-allowed"}`,children:[t("blocks.continue"),e.jsx(J,{className:"w-5 h-5"})]})]})})]})}const Fs={link:is,download:ns,video:we,document:Oe},Le={link:{bg:"bg-blue-100",icon:"text-blue-600",hover:"hover:bg-blue-50"},download:{bg:"bg-emerald-100",icon:"text-emerald-600",hover:"hover:bg-emerald-50"},video:{bg:"bg-rose-100",icon:"text-rose-600",hover:"hover:bg-rose-50"},document:{bg:"bg-amber-100",icon:"text-amber-600",hover:"hover:bg-amber-50"}};function Bs({content:s,onComplete:v,previousOutput:l}){const{t}=G(),[n,o]=r.useState(new Set(l?.viewedResources||[])),i=u=>{if(o(p=>new Set([...p,u.id])),u.type==="download"){const p=document.createElement("a");p.href=u.url,p.download=u.title,p.target="_blank",document.body.appendChild(p),p.click(),document.body.removeChild(p)}else window.open(u.url,"_blank","noopener,noreferrer")},E=()=>{v({viewedResources:Array.from(n)})},N=n.size,b=s.resources.length,k=b>0?N/b*100:0,j=b-N;return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsxs("div",{className:"border-b border-slate-200 px-6 py-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center",children:e.jsx(rs,{className:"w-5 h-5 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900",children:s.title}),s.description&&e.jsx("p",{className:"text-sm text-slate-500",children:s.description})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-1 h-1.5 bg-slate-100 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-indigo-500 transition-all duration-300",style:{width:`${k}%`}})}),e.jsx("span",{className:"text-sm text-slate-500",children:t("blocks.resource.viewedProgress",{viewed:N,total:b})})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-6",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:s.resources.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(Me,{className:"w-12 h-12 text-slate-300 mb-4"}),e.jsx("p",{className:"text-slate-500",children:t("blocks.resource.empty")})]}):e.jsx("div",{className:"space-y-3",children:s.resources.map(u=>{const p=Fs[u.type]||Me,a=Le[u.type]||Le.link,x=n.has(u.id);return e.jsxs("button",{onClick:()=>i(u),className:`w-full flex items-center gap-4 p-4 rounded-xl border transition-all text-left group ${x?"border-emerald-200 bg-emerald-50/50":`border-slate-200 ${a.hover}`}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0 ${x?"bg-emerald-100":a.bg}`,children:x?e.jsx(le,{className:"w-6 h-6 text-emerald-600"}):e.jsx(p,{className:`w-6 h-6 ${a.icon}`})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-medium text-slate-900 truncate",children:u.title}),u.type==="download"&&e.jsx("span",{className:"px-2 py-0.5 text-xs font-medium bg-slate-100 text-slate-600 rounded",children:t("blocks.resource.download")})]}),u.description&&e.jsx("p",{className:"text-sm text-slate-500 mt-1 line-clamp-2",children:u.description}),e.jsxs("div",{className:"flex items-center gap-1 mt-1 text-xs text-slate-400",children:[e.jsx(ve,{className:"w-3 h-3"}),e.jsx("span",{className:"truncate",children:u.url})]})]}),e.jsx(ve,{className:`w-5 h-5 flex-shrink-0 transition-transform group-hover:translate-x-0.5 group-hover:-translate-y-0.5 ${x?"text-emerald-500":"text-slate-400"}`})]},u.id)})})})}),e.jsx("div",{className:"border-t border-slate-200 px-6 py-4 bg-slate-50",children:e.jsxs("div",{className:"flex items-center justify-between max-w-3xl mx-auto",children:[e.jsx("div",{className:"text-sm text-slate-500",children:N===b?t("blocks.resource.allViewed"):j===1?t("blocks.resource.remainingSingle"):t("blocks.resource.remainingMultiple",{count:j})}),e.jsxs("button",{onClick:E,className:"flex items-center gap-2 px-6 py-3 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors",children:[t("blocks.continue"),e.jsx(J,{className:"w-5 h-5"})]})]})})]})}function Zs({journeyVersionId:s,userId:v,graph:l,onComplete:t,onExit:n,trackDirection:o,trackLanguage:i,trackIdProp:E,currentModuleIdProp:N}){const{t:b}=G(),{showToast:k}=Xe(),[j,u]=r.useState(null),[p,a]=r.useState(null),[x,h]=r.useState(null),[C,d]=r.useState(!0),[g,T]=r.useState(null),[R,f]=r.useState(new Map),[m,_]=r.useState({}),[$,S]=r.useState(!1),[c,y]=r.useState(null),[I,V]=r.useState(null),[q,D]=r.useState(o||"ltr"),[W,K]=r.useState(i||"en"),[ne,ie]=r.useState(E),[M,O]=r.useState(N),X=r.useRef(Date.now());r.useEffect(()=>{oe(),ce()},[]);const ce=async()=>{try{const{data:w}=await P.from("journey_versions").select("module_id").eq("id",s).single();if(!w)return;O(w.module_id);const{data:A}=await P.from("modules").select("track_id").eq("id",w.module_id).single();if(!A||(ie(A.track_id),o))return;const{data:L}=await P.from("tracks").select("direction, primary_language").eq("id",A.track_id).single();L&&(D(L.direction||"ltr"),K(L.primary_language||"en"))}catch(w){console.error("Error loading track settings:",w)}},oe=async()=>{d(!0),T(null);try{const{data:w,error:A}=await P.from("user_journey_runs").select("*").eq("user_id",v).eq("journey_version_id",s).neq("status","completed").neq("status","abandoned").maybeSingle();if(A)throw console.error("Failed to fetch existing run:",A),new Error(b("journey.error.failed"));let L=w;if(!L){const{data:U,error:Z}=await P.from("user_journey_runs").insert({user_id:v,journey_version_id:s,current_block_id:l.startBlockId,status:"in_progress",started_at:new Date().toISOString()}).select().single();if(Z)throw console.error("Failed to create journey run:",Z),new Error(b("journey.error.failed"));L=U}u(L);const{data:z,error:B}=await P.from("user_block_states").select("*").eq("run_id",L.id);if(B&&console.error("Failed to load block states:",B),z){const U=new Map;z.forEach(Z=>{U.set(Z.block_id,Z)}),f(U)}const Y=L.current_block_id||l.startBlockId;await ae(Y,L.id)}catch(w){console.error("Journey initialization error:",w);const A=w instanceof Error?w.message:"Failed to initialize journey";T(A),k("error",A)}finally{d(!1)}},ae=async(w,A)=>{const L=l.blocks.find(B=>B.id===w);if(!L){console.error("Block not found:",w);return}a(L),X.current=Date.now(),await P.from("user_journey_runs").update({current_block_id:w}).eq("id",A);let z=R.get(w);if(!z){const{data:B,error:Y}=await P.from("user_block_states").select("*").eq("run_id",A).eq("block_id",w).maybeSingle();if(Y&&console.error("Error fetching block state:",Y),B)z=B,f(U=>new Map(U).set(w,B));else{const{data:U,error:Z}=await P.from("user_block_states").insert({run_id:A,block_id:w,status:"in_progress",started_at:new Date().toISOString()}).select().single();!Z&&U&&(z=U,f(fe=>new Map(fe).set(w,U)))}}if(z&&z.status==="not_started"){const{data:B}=await P.from("user_block_states").update({status:"in_progress",started_at:new Date().toISOString()}).eq("id",z.id).select().single();B&&(z=B,f(Y=>new Map(Y).set(w,B)))}h(z||null)},F=r.useCallback(async(w,A,L)=>{if(!p||!j||!x)return;const z=Math.floor((Date.now()-X.current)/1e3),{data:B}=await P.from("user_block_states").update({status:"completed",output_json:w||{},score:A??null,weak_topics:L||[],time_spent_seconds:(x.time_spent_seconds||0)+z,completed_at:new Date().toISOString(),attempts_count:(x.attempts_count||0)+1}).eq("id",x.id).select().single();B&&f(Z=>new Map(Z).set(p.id,B));const Y=Ie({score:A,weak_topics:L,attempts_count:(x.attempts_count||0)+1,time_spent_seconds:(x.time_spent_seconds||0)+z,status:"completed",output_json:w},p.type==="quiz"?p.content:void 0),U=vs(p.id,l.edges,Y);if(U)await ae(U,j.id);else{await P.from("user_journey_runs").update({status:"completed",completed_at:new Date().toISOString()}).eq("id",j.id);const Z=Array.from(R.values());B&&Z.push(B);const fe=Z.reduce((Q,ge)=>Q+(ge.time_spent_seconds||0),0),be=Z.filter(Q=>Q.score!==null).map(Q=>Q.score),Ze=be.length>0?be.reduce((Q,ge)=>Q+ge,0)/be.length:0;y({totalTime:fe,blocksCompleted:Z.filter(Q=>Q.status==="completed").length,averageScore:Math.round(Ze)});const Je=await ue();V(Je),S(!0)}},[p,j,x,l.edges,R]),de=r.useCallback(async w=>{if(!p)return;const A=p.content;if(w.passed)_({});else{const L=A.questions.filter(z=>w.answers[z.id]!==z.correctIndex).map(z=>({prompt:z.prompt,userAnswer:z.choices[w.answers[z.id]]||"No answer",correctAnswer:z.choices[z.correctIndex],explanation:z.explanation}));_({wrongQuestions:L,weakTopics:w.weakTopics})}await F({answers:w.answers,passed:w.passed},w.score,w.weakTopics)},[p,F]),me=r.useCallback(async w=>{await F({passed:w},w?100:0)},[F]),ue=async()=>{if(!ne||!M)return null;try{const{data:w}=await P.from("modules").select("order_index").eq("id",M).single();if(!w)return null;const{data:A}=await P.from("modules").select("id, title, journey_versions(id, status)").eq("track_id",ne).eq("order_index",w.order_index+1).maybeSingle();if(!A)return null;const L=A.journey_versions?.find(z=>z.status==="published");return L?{versionId:L.id,moduleTitle:A.title}:null}catch(w){return console.error("Error checking for next module:",w),null}},ee=async()=>{if(j)try{const{error:w}=await P.from("user_block_states").delete().eq("run_id",j.id);if(w)throw console.error("Failed to clear block states:",w),new Error("Failed to reset progress");const{error:A}=await P.from("user_journey_runs").update({status:"in_progress",current_block_id:l.startBlockId,completed_at:null}).eq("id",j.id);if(A)throw console.error("Failed to reset journey run:",A),new Error("Failed to restart journey");f(new Map),S(!1),y(null),k("success",b("journey.completion.restart")),await ae(l.startBlockId,j.id)}catch(w){console.error("Restart journey error:",w),k("error",b("journey.error.failed"))}},pe=w=>{const A=Math.floor(w/60),L=w%60;return A>0?`${A}m ${L}s`:`${L}s`},Pe=()=>{if(!p||!x)return null;const w=x.status==="completed";switch(p.type){case"read":return e.jsx(_s,{content:p.content,onComplete:()=>F(),isCompleted:w,trackId:ne,moduleId:M});case"video":return e.jsx(Ts,{content:p.content,onComplete:()=>F(),isCompleted:w});case"image":return e.jsx(Is,{content:p.content,onComplete:()=>F(),isCompleted:w});case"quiz":return e.jsx(Ls,{content:p.content,onComplete:de,previousAttempt:x.output_json?.answers?{score:x.score||0,correctCount:Math.round((x.score||0)/100*p.content.questions.length),totalCount:p.content.questions.length,answers:x.output_json.answers,weakTopics:x.weak_topics||[],passed:(x.score||0)>=(p.content.passingScore??50)}:void 0});case"mission":return e.jsx(Rs,{content:p.content,onComplete:L=>F(L),previousOutput:x.output_json});case"form":return e.jsx($s,{content:p.content,onComplete:L=>F(L),previousOutput:x.output_json});case"ai_help":return e.jsx(As,{content:p.content,weakTopics:m.weakTopics,wrongQuestions:m.wrongQuestions,onComplete:L=>F(L)});case"checkpoint":const A=Ie(x);return e.jsx(zs,{content:p.content,facts:A,onComplete:me});case"animation":return e.jsx(Vs,{content:p.content,onComplete:()=>F(),isCompleted:w});case"code":return e.jsx(qs,{content:p.content,onComplete:()=>F(),isCompleted:w});case"exercise":return e.jsx(Os,{content:p.content,onComplete:L=>F(L),previousOutput:x.output_json});case"resource":return e.jsx(Bs,{content:p.content,onComplete:L=>F(L),previousOutput:x.output_json});default:return e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("p",{className:"text-slate-500",children:["Unknown block type: ",p.type]})})}};if(C)return e.jsx("div",{className:"flex items-center justify-center h-screen bg-slate-100",children:e.jsxs("div",{className:"text-center",children:[e.jsx(te,{className:"w-12 h-12 text-primary-600 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-slate-600",children:b("journey.loading")})]})});if(g)return e.jsx("div",{className:"flex items-center justify-center h-screen bg-slate-100",children:e.jsxs("div",{className:"text-center max-w-md px-4",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 bg-error/20 rounded-full flex items-center justify-center",children:e.jsx(ze,{className:"w-8 h-8 text-error"})}),e.jsx("h2",{className:"text-xl font-semibold text-slate-900 mb-2",children:b("journey.error.title")}),e.jsx("p",{className:"text-slate-600 mb-6",children:g}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("button",{onClick:()=>oe(),className:"w-full flex items-center justify-center gap-2 px-6 py-3 bg-primary-600 text-white rounded-xl font-semibold hover:bg-primary-700 transition-colors",children:[e.jsx(re,{className:"w-5 h-5"}),b("journey.error.tryAgain")]}),e.jsxs("button",{onClick:n,className:"w-full flex items-center justify-center gap-2 px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-semibold hover:bg-slate-300 transition-colors",children:[e.jsx(je,{className:"w-5 h-5"}),b("journey.error.backToDashboard")]})]})]})});if($)return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-600 via-blue-700 to-cyan-600 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl max-w-lg w-full p-8 text-center",children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx("div",{className:"w-24 h-24 mx-auto bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center shadow-lg",children:e.jsx(hs,{className:"w-12 h-12 text-white"})}),e.jsx("div",{className:"absolute -top-2 -right-2 w-8 h-8 bg-primary-500 rounded-full flex items-center justify-center animate-bounce",children:e.jsx(he,{className:"w-4 h-4 text-white"})})]}),e.jsx("h1",{className:"text-3xl font-bold text-slate-900 mb-2",children:b("journey.completion.title")}),e.jsx("p",{className:"text-slate-600 mb-8",children:b("journey.completion.congratulations")}),c&&e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-8",children:[e.jsxs("div",{className:"bg-slate-50 rounded-xl p-4",children:[e.jsx("div",{className:"w-10 h-10 mx-auto mb-2 bg-primary-100 rounded-lg flex items-center justify-center",children:e.jsx(Ae,{className:"w-5 h-5 text-primary-600"})}),e.jsx("div",{className:"text-2xl font-bold text-slate-900",children:c.blocksCompleted}),e.jsx("div",{className:"text-xs text-slate-500",children:b("journey.completion.stats.blocksCompleted")})]}),e.jsxs("div",{className:"bg-slate-50 rounded-xl p-4",children:[e.jsx("div",{className:"w-10 h-10 mx-auto mb-2 bg-warning/20 rounded-lg flex items-center justify-center",children:e.jsx(xs,{className:"w-5 h-5 text-warning"})}),e.jsxs("div",{className:"text-2xl font-bold text-slate-900",children:[c.averageScore,"%"]}),e.jsx("div",{className:"text-xs text-slate-500",children:b("journey.completion.stats.averageScore")})]}),e.jsxs("div",{className:"bg-slate-50 rounded-xl p-4",children:[e.jsx("div",{className:"w-10 h-10 mx-auto mb-2 bg-emerald-100 rounded-lg flex items-center justify-center",children:e.jsx($e,{className:"w-5 h-5 text-emerald-600"})}),e.jsx("div",{className:"text-2xl font-bold text-slate-900",children:pe(c.totalTime)}),e.jsx("div",{className:"text-xs text-slate-500",children:b("journey.completion.stats.timeSpent")})]})]}),e.jsx("div",{className:"flex flex-col gap-3",children:I?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>t(I),className:"w-full flex items-center justify-center gap-2 px-6 py-4 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors",children:[e.jsx(he,{className:"w-5 h-5"}),b("journey.completion.continueToNext",{module:I.moduleTitle})]}),e.jsxs("button",{onClick:()=>t(),className:"w-full flex items-center justify-center gap-2 px-6 py-4 bg-slate-100 text-slate-700 rounded-xl font-semibold hover:bg-slate-200 transition-colors",children:[e.jsx(je,{className:"w-5 h-5"}),b("journey.completion.backToDashboard")]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>t(),className:"w-full flex items-center justify-center gap-2 px-6 py-4 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors",children:[e.jsx(je,{className:"w-5 h-5"}),b("journey.completion.backToDashboard")]}),e.jsxs("button",{onClick:ee,className:"w-full flex items-center justify-center gap-2 px-6 py-4 bg-slate-100 text-slate-700 rounded-xl font-semibold hover:bg-slate-200 transition-colors",children:[e.jsx(re,{className:"w-5 h-5"}),b("journey.completion.restart")]})]})})]})});const Ne=Array.from(R.values()).filter(w=>w.status==="completed").length,De=Ne/l.blocks.length*100,se=q==="rtl";return e.jsx(Qe,{direction:q,primaryLanguage:W,children:e.jsxs("div",{className:"flex flex-col h-screen bg-slate-100",children:[e.jsxs("header",{className:`bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between ${se?"flex-row-reverse":""}`,children:[e.jsxs("button",{onClick:n,className:`flex items-center gap-2 text-slate-600 hover:text-slate-900 transition-colors ${se?"flex-row-reverse":""}`,children:[e.jsx(He,{className:`w-5 h-5 ${se?"rotate-180":""}`}),e.jsx("span",{className:"font-medium",children:b("journey.exit")})]}),e.jsxs("div",{className:`flex items-center gap-4 ${se?"flex-row-reverse":""}`,children:[e.jsx("div",{className:"w-48 h-2 bg-slate-200 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full bg-primary-600 transition-all duration-300 ${se?"mr-auto":""}`,style:{width:`${De}%`,marginLeft:se?"auto":void 0,marginRight:se?"0":void 0}})}),e.jsxs("span",{className:"text-sm text-slate-500 font-medium",children:[Ne," / ",l.blocks.length]})]})]}),e.jsx("main",{className:"flex-1 overflow-hidden",children:Pe()})]})})}export{Zs as JourneyRunner};
